<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stellar Contract Integration Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-header {
            background: #1a1a1a;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .test-section {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        .test-result {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .code {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .progress {
            background-color: #e9ecef;
            border-radius: 4px;
            height: 20px;
            margin: 10px 0;
        }
        .progress-bar {
            background-color: #007bff;
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }
    </style>
</head>
<body>
    <div class="test-header">
        <h1>🧪 Stellar Contract Integration Test</h1>
        <p>Testing DOB Validator Smart Contract Integration</p>
    </div>

    <div class="test-container">
        <h2>Test Controls</h2>
        <button id="runAllTests">Run All Tests</button>
        <button id="clearResults">Clear Results</button>
        <div class="progress">
            <div class="progress-bar" id="progressBar"></div>
        </div>
    </div>

    <div class="test-container">
        <h2>Test Results</h2>
        <div id="testResults"></div>
    </div>

    <script type="module">
        // Mock Stellar SDK for testing
        const mockStellarSDK = {
            TransactionBuilder: class {
                constructor(account, options) {
                    this.account = account;
                    this.options = options;
                    this.operations = [];
                    this.memo = null;
                    this.timeout = 30;
                }
                
                addOperation(operation) {
                    this.operations.push(operation);
                    return this;
                }
                
                addMemo(memo) {
                    this.memo = memo;
                    return this;
                }
                
                setTimeout(timeout) {
                    this.timeout = timeout;
                    return this;
                }
                
                build() {
                    return {
                        toXDR: () => 'AAAAAgAAAAAAAAAAAAAA...mock_xdr_transaction...',
                        source: this.account.publicKey,
                        operations: this.operations
                    };
                }
            },
            Account: class {
                constructor(publicKey, sequence) {
                    this.publicKey = publicKey;
                    this.sequence = sequence;
                }
            },
            Networks: {
                TESTNET: 'Test SDF Network ; September 2015'
            },
            Operation: {
                manageData: (data) => ({
                    type: 'manageData',
                    name: data.name,
                    value: data.value
                })
            },
            Memo: {
                text: (text) => ({
                    type: 'text',
                    value: text
                })
            },
            BASE_FEE: '100'
        };

        // Mock the Stellar Contract Service
        class MockStellarContractService {
            async initialize() {
                return true;
            }

            createTrufaMetadata(data) {
                const metadata = {
                    ...data,
                    decisionAt: new Date().toISOString(),
                    metadataHash: this.generateMetadataHash(data)
                };
                return metadata;
            }

            generateMetadataHash(data) {
                const metadataString = JSON.stringify(data, Object.keys(data).sort());
                let hash = 0;
                for (let i = 0; i < metadataString.length; i++) {
                    const char = metadataString.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                return Math.abs(hash).toString(16);
            }

            async createValidationTransaction(adminWalletAddress, metadata, sequenceNumber = '0') {
                const transaction = new mockStellarSDK.TransactionBuilder(
                    new mockStellarSDK.Account(adminWalletAddress, sequenceNumber),
                    {
                        fee: mockStellarSDK.BASE_FEE,
                        networkPassphrase: mockStellarSDK.Networks.TESTNET
                    }
                )
                .addOperation(
                    mockStellarSDK.Operation.manageData({
                        name: 'dob_validation',
                        value: JSON.stringify(metadata)
                    })
                )
                .addMemo(mockStellarSDK.Memo.text(`DOB_VALIDATION_${metadata.submissionId}`))
                .setTimeout(30)
                .build();

                return transaction;
            }

            async submitValidation(adminWalletAddress, metadata) {
                const transaction = await this.createValidationTransaction(adminWalletAddress, metadata);
                
                return {
                    success: true,
                    metadata: {
                        xdr: transaction.toXDR(),
                        network: mockStellarSDK.Networks.TESTNET,
                        description: 'DOB Validator - Submit TRUFA Validation',
                        contractAddress: 'CBS3QODERORJH4GPDAWNQMUNTB4O6LO6NUETRXE5H2NSR3G542QOWKTN'
                    }
                };
            }

            async verifyAdminWallet(walletAddress) {
                const adminWallets = [
                    'GCKFBEIYTKP6RJGWLOUQBCGWDLNVTQJDKB7NQIU7SFJBQYDVD5GQJJQJ'
                ];
                return adminWallets.includes(walletAddress);
            }

            async getValidation(submissionId) {
                return {
                    success: true,
                    metadata: {
                        submissionId,
                        status: 'APPROVED',
                        timestamp: new Date().toISOString(),
                        contractAddress: 'CBS3QODERORJH4GPDAWNQMUNTB4O6LO6NUETRXE5H2NSR3G542QOWKTN'
                    }
                };
            }

            async getContractStats() {
                return {
                    success: true,
                    metadata: {
                        totalValidations: 0,
                        approvedValidations: 0,
                        rejectedValidations: 0,
                        contractAddress: 'CBS3QODERORJH4GPDAWNQMUNTB4O6LO6NUETRXE5H2NSR3G542QOWKTN',
                        lastUpdated: new Date().toISOString()
                    }
                };
            }
        }

        // Mock Admin Config Service
        class MockAdminConfigService {
            constructor() {
                this.adminWallets = [
                    {
                        address: 'GCKFBEIYTKP6RJGWLOUQBCGWDLNVTQJDKB7NQIU7SFJBQYDVD5GQJJQJ',
                        name: 'Primary Validator',
                        role: 'SUPER_ADMIN',
                        permissions: ['approve', 'reject', 'review', 'manage_users', 'view_stats'],
                        isActive: true
                    }
                ];
            }

            isAdminWallet(walletAddress) {
                return this.adminWallets.some(wallet => 
                    wallet.address === walletAddress && wallet.isActive
                );
            }

            getAdminWallet(walletAddress) {
                return this.adminWallets.find(wallet => 
                    wallet.address === walletAddress && wallet.isActive
                ) || null;
            }

            hasPermission(walletAddress, permission) {
                const admin = this.getAdminWallet(walletAddress);
                if (!admin) return false;
                return admin.permissions.includes(permission);
            }

            getAdminStats() {
                const activeAdmins = this.adminWallets.filter(wallet => wallet.isActive);
                return {
                    totalAdmins: activeAdmins.length,
                    superAdmins: activeAdmins.filter(a => a.role === 'SUPER_ADMIN').length,
                    validators: activeAdmins.filter(a => a.role === 'VALIDATOR').length,
                    reviewers: activeAdmins.filter(a => a.role === 'REVIEWER').length
                };
            }
        }

        // Test runner
        class TestRunner {
            constructor() {
                this.stellarService = new MockStellarContractService();
                this.adminService = new MockAdminConfigService();
                this.results = [];
                this.currentTest = 0;
                this.totalTests = 8;
            }

            log(message, type = 'info') {
                const resultDiv = document.createElement('div');
                resultDiv.className = `test-result ${type}`;
                resultDiv.innerHTML = message;
                document.getElementById('testResults').appendChild(resultDiv);
            }

            updateProgress() {
                this.currentTest++;
                const progress = (this.currentTest / this.totalTests) * 100;
                document.getElementById('progressBar').style.width = `${progress}%`;
            }

            async runAllTests() {
                document.getElementById('testResults').innerHTML = '';
                this.currentTest = 0;
                document.getElementById('progressBar').style.width = '0%';

                this.log('🧪 Starting Stellar Contract Integration Tests...', 'info');
                this.log('='.repeat(60), 'info');

                try {
                    await this.test1_Initialize();
                    await this.test2_CreateMetadata();
                    await this.test3_VerifyAdmin();
                    await this.test4_CreateTransaction();
                    await this.test5_SubmitValidation();
                    await this.test6_GetValidation();
                    await this.test7_GetStats();
                    await this.test8_AdminConfig();

                    this.log('🎉 All tests passed successfully!', 'success');
                    this.log('='.repeat(60), 'success');
                    this.log('✅ Stellar Contract Integration is working correctly', 'success');
                    this.log('✅ Admin Wallet Authentication is functional', 'success');
                    this.log('✅ TRUFA Metadata generation is working', 'success');
                    this.log('✅ Transaction creation is successful', 'success');
                    this.log('✅ Ready for database integration!', 'success');

                } catch (error) {
                    this.log(`❌ Test failed: ${error.message}`, 'error');
                    console.error('Test error:', error);
                }
            }

            async test1_Initialize() {
                this.log('<strong>📋 Test 1: Initialize Stellar Contract Service</strong>', 'info');
                
                const result = await this.stellarService.initialize();
                this.log(`✅ Initialization result: ${result}`, 'success');
                
                if (!result) {
                    throw new Error('Failed to initialize Stellar Contract Service');
                }
                
                this.updateProgress();
            }

            async test2_CreateMetadata() {
                this.log('<strong>📋 Test 2: Create TRUFA Metadata</strong>', 'info');
                
                const sampleData = {
                    submissionId: 'TEST_SUB_001',
                    deviceName: 'Helium Chile Expansion',
                    deviceType: 'Network Infrastructure',
                    operatorWallet: 'GAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWHF',
                    validatorWallet: 'GCKFBEIYTKP6RJGWLOUQBCGWDLNVTQJDKB7NQIU7SFJBQYDVD5GQJJQJ',
                    trufaScores: {
                        technical: 85,
                        regulatory: 90,
                        financial: 75,
                        environmental: 80,
                        overall: 82
                    },
                    decision: 'APPROVED'
                };

                const metadata = this.stellarService.createTrufaMetadata(sampleData);
                this.log('✅ Metadata created successfully', 'success');
                this.log(`<div class="code">${JSON.stringify(metadata, null, 2)}</div>`, 'info');
                
                this.updateProgress();
            }

            async test3_VerifyAdmin() {
                this.log('<strong>📋 Test 3: Verify Admin Wallet</strong>', 'info');
                
                const adminWallet = 'GCKFBEIYTKP6RJGWLOUQBCGWDLNVTQJDKB7NQIU7SFJBQYDVD5GQJJQJ';
                const isAdmin = await this.stellarService.verifyAdminWallet(adminWallet);
                this.log(`✅ Admin verification result: ${isAdmin}`, 'success');
                
                this.updateProgress();
            }

            async test4_CreateTransaction() {
                this.log('<strong>📋 Test 4: Create Validation Transaction</strong>', 'info');
                
                const adminWallet = 'GCKFBEIYTKP6RJGWLOUQBCGWDLNVTQJDKB7NQIU7SFJBQYDVD5GQJJQJ';
                const metadata = this.stellarService.createTrufaMetadata({
                    submissionId: 'TEST_SUB_001',
                    deviceName: 'Test Device',
                    deviceType: 'Test Type',
                    operatorWallet: 'GAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWHF',
                    validatorWallet: adminWallet,
                    trufaScores: { technical: 85, regulatory: 90, financial: 75, environmental: 80, overall: 82 },
                    decision: 'APPROVED'
                });

                const transaction = await this.stellarService.createValidationTransaction(
                    adminWallet,
                    metadata,
                    '123456789'
                );
                
                this.log('✅ Transaction created successfully', 'success');
                this.log(`📄 Transaction XDR length: ${transaction.toXDR().length}`, 'info');
                this.log(`📄 Transaction XDR preview: ${transaction.toXDR().substring(0, 100)}...`, 'info');
                
                this.updateProgress();
            }

            async test5_SubmitValidation() {
                this.log('<strong>📋 Test 5: Submit Validation</strong>', 'info');
                
                const adminWallet = 'GCKFBEIYTKP6RJGWLOUQBCGWDLNVTQJDKB7NQIU7SFJBQYDVD5GQJJQJ';
                const metadata = this.stellarService.createTrufaMetadata({
                    submissionId: 'TEST_SUB_001',
                    deviceName: 'Test Device',
                    deviceType: 'Test Type',
                    operatorWallet: 'GAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWHF',
                    validatorWallet: adminWallet,
                    trufaScores: { technical: 85, regulatory: 90, financial: 75, environmental: 80, overall: 82 },
                    decision: 'APPROVED'
                });

                const result = await this.stellarService.submitValidation(adminWallet, metadata);
                this.log('✅ Submit result:', 'success');
                this.log(`<div class="code">${JSON.stringify(result, null, 2)}</div>`, 'info');
                
                this.updateProgress();
            }

            async test6_GetValidation() {
                this.log('<strong>📋 Test 6: Get Validation</strong>', 'info');
                
                const result = await this.stellarService.getValidation('TEST_SUB_001');
                this.log('✅ Get validation result:', 'success');
                this.log(`<div class="code">${JSON.stringify(result, null, 2)}</div>`, 'info');
                
                this.updateProgress();
            }

            async test7_GetStats() {
                this.log('<strong>📋 Test 7: Get Contract Stats</strong>', 'info');
                
                const result = await this.stellarService.getContractStats();
                this.log('✅ Contract stats:', 'success');
                this.log(`<div class="code">${JSON.stringify(result, null, 2)}</div>`, 'info');
                
                this.updateProgress();
            }

            async test8_AdminConfig() {
                this.log('<strong>📋 Test 8: Admin Config Service</strong>', 'info');
                
                const adminWallet = 'GCKFBEIYTKP6RJGWLOUQBCGWDLNVTQJDKB7NQIU7SFJBQYDVD5GQJJQJ';
                const adminDetails = this.adminService.getAdminWallet(adminWallet);
                this.log('✅ Admin details:', 'success');
                this.log(`<div class="code">${JSON.stringify(adminDetails, null, 2)}</div>`, 'info');
                
                const hasPermission = this.adminService.hasPermission(adminWallet, 'approve');
                this.log(`✅ Has approve permission: ${hasPermission}`, 'success');
                
                const adminStats = this.adminService.getAdminStats();
                this.log('✅ Admin stats:', 'success');
                this.log(`<div class="code">${JSON.stringify(adminStats, null, 2)}</div>`, 'info');
                
                this.updateProgress();
            }
        }

        // Initialize test runner
        const testRunner = new TestRunner();

        // Event listeners
        document.getElementById('runAllTests').addEventListener('click', () => {
            testRunner.runAllTests();
        });

        document.getElementById('clearResults').addEventListener('click', () => {
            document.getElementById('testResults').innerHTML = '';
            document.getElementById('progressBar').style.width = '0%';
        });

        // Auto-run tests on page load
        window.addEventListener('load', () => {
            testRunner.runAllTests();
        });
    </script>
</body>
</html> 